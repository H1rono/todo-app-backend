version: "3"

tasks:
  build:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose build
      - cargo build

  dev:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose -f docker-compose.yml --env-file .env.dev up -d

  dev-db:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose -f docker-compose.sub.yml --env-file .env.dev up -d --wait

  serve:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose -f docker-compose.yml --env-file .env up -d

  serve-db:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose -f docker-compose.sub.yml --env-file .env up -d

  ci-db:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose -f docker-compose.sub.yml --env-file .env.dev up -d --wait
      - docker compose -f docker-compose.sub.yml --env-file .env.dev down

  ci-cargo:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - CARGO_INCREMENTAL=1 cargo build --release --all-features
      - cargo fmt --all -- --check
      - cargo clippy --all-targets --all-features -- -D warnings

  down-dev:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose --env-file .env.dev down

  down:
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - docker compose --env-file .env down
